var y=function(e,t){var l=this;this.element=t,_.bindAll(this,"xhrProgress"),this.state="queued",this.url=e,this.promise=$.Deferred(),this.promise.request=this,this.promise.cancel=function(){l.state==="active"?l.xhr&&l.xhr.abort():l.state="cancelled"}};y.enableXHR=!0;y.failures=0;y.prototype={doDownload:function(e){var t=this;if(this.state="active",Modernizr.xhrresponsetypeblob&&y.enableXHR&&!e)this.xhr=$.ajax({dataType:"native",url:this.url,xhrFields:{responseType:"blob",onprogress:this.xhrProgress}}),this.startTime=Date.now(),this.promise.notify({loaded:0,total:1}),this.xhr.then(function(o){t.state="complete",t.promise.resolve(o)}),this.xhr.fail(function(o,s){if(s!=="abort"&&!e)return y.failures+=1,y.failures>=5&&(y.enableXHR=!1),t.doDownload(!0);t.state="failed",t.error=o,t.promise.reject(o)});else{this.element.src=this.url;var l=imagesLoaded(this.element,function(){l.images[0].isLoaded?(t.state="complete",t.promise.resolve("fallback")):(t.state="failed",t.promise.reject({fallbackError:"failed"}))})}},xhrProgress:function(e){this.promise.notify(e)}};var q={activeCount:0,active:null,queued:null,requests:{},complete:{},download:function(e,t){var l;if(l=this.requests[e],l){if(l.state==="complete"||l.state==="active")return l.promise;if(l.state==="queued")return this.moveToFront(l),l.promise}return l=new y(e,t),this.requests[e]=l,this.addToFront(l),l.promise},refresh:function(e){var t=e.request;t.state==="queued"&&this.moveToFront(t)},activate:function(e){if(!(this.activeCount>=5)){this.activeCount+=1;var t=this;this.active=this.remove(e),e.doDownload(),e.promise.always(function(){t.activeCount-=1,t.active=null,t.activateNext()}),this.active===this.front&&(this.front=null)}},activateNext:function(){this.queued&&this.activeCount<5&&(this.queued.state==="cancelled"?(this.remove(this.queued),this.activateNext()):this.activate(this.queued))},addToFront:function(e){this.activeCount<5?this.activate(e):this.queued?this.front?(e.next=this.front.next,this.front.next=e,e.prev=this.front,this.front=e,e.next&&(e.next.prev=e)):(e.next=this.queued,this.front=e,this.queued=e,e.next.prev=e):(this.queued=e,this.front=e)},moveToFront:function(e){this.remove(e),this.addToFront(e)},remove:function(e){var t=e.next,l=e.prev;return this.queued===e&&(this.queued=t),this.front===e&&(this.front=t),t&&(t.prev=l),l&&(l.next=t),e.next=null,e.prev=null,e},resetPriority:function(){this.front=null}};const J={scale:1,visible:!1,preload:!1,loader:null,cache:{}};class ee{constructor(t){Object.assign(this,J,t)}init(){let t=$("<img></img>").appendTo(this.$el);this.img=t[0];let l=this.size.height/this.size.width,o=$('<div class="aspect-ratio-spacer"></div>').css({"margin-top":l*100+"%"});this.$el.append(o),this.$el.find("img").css({"border-bottom-width":l*5+"px"}).toggleClass("aspect-ratio-wide",l<11/8.5).attr("alt",this.alt),Modernizr.touchevents||this.preloadImage("thumb")}handleVisible(){_.defer(()=>{if(this.visible){let t=this.scale;this.$el.width()>this.size.width||t>2?this.preloadImage("full"):this.$el.width()<250?this.preloadImage("thumb"):this.preloadImage("screen")}})}downloadProgress(t){this.percentLoaded=t.loaded/(t.total||150*1024)*100}preloadImage(t){if(this.loader)if(this.loader.size==t){q.refresh(this.loader);return}else this.loader.cancel();let l=["thumb","screen","full","screen","thumb"],o;for(let i=l.indexOf(t);i<l.length&&(t=l[i],o=this.urls[t],!o);i++);l=["thumb","screen","full"];let s;for(let i=l.indexOf(t);i<l.length&&(s=s||this.cache[l[i]],!s);i++);if(s){this.url=s,this.preloaded=t;return}this.preloaded=null,this.loader=q.download(o,this.img),this.loader.size=t,this.loader.progress(this.downloadProgress).then(i=>{if(i=="fallback")this.cache[t]=this.img.src,this.url=this.img.src,this.preloaded=t,this.loader=null;else{let r=new FileReader;r.readAsDataURL(i),r.onload=()=>{this.cache[t]=r.result,this.url=r.result,this.preloaded=t,this.loader=null}}}).fail(i=>{console.log("preloadImage failed"),console.dir(this),this.loader=null})}}let M=1,k=null,U="scoll",X=null,K=null,f=1,d=1,W=null,S=!1,P=null,c=null,h=[],I=null,z=null,m=null,O=null;const D=e=>{h[M-1].$el.removeClass("current"),M=Math.min(Math.max(e,X),K);let t=document.getElementById("page-selector");t.value=M;let l=h[M-1];l.$el.addClass("current"),P=null,Y(l)},A=e=>{P=e;let t=$(".viewport-content");(!c||c.$el[0].offsetTop+c.$el[0].offsetHeight>t.scrollTop()+t.height()||c.$el[0].offsetTop<t.scrollTop())&&Y(P)},Y=e=>{let t=$(".viewport-content"),l=c;e||(c=l),c=e,c.current=!0,l&&(l.current=!1),c!==P&&((t.scrollTop()>c.el.offsetTop||t.scrollTop()+t.height()<c.el.offsetTop+c.el.offsetHeight)&&t.scrollTop(c.el.offsetTop),(t.scrollLeft()>c.el.offsetLeft||t.scrollLeft()+t.width()<c.el.offsetLeft+c.el.offsetWidth)&&t.scrollLeft(c.el.offsetLeft))},F=(e,t)=>{U=t,e.removeClass("tool-magnify tool-scroll"),e.off("mousewheel",Q),e.off("click",L),e.off("contextmenu",L),e.off("dblclick",L),t==="magnify"?(e.addClass("tool-magnify"),e.on("mousewheel",Q),e.on("dblclick",L)):(e.addClass("tool-scroll"),e.on("click",L),e.on("contextmenu",L))};let H;const te=e=>{if(S=!S,S){let t=e[0].getBoundingClientRect();H={position:"fixed",left:Math.max(0,t.left),top:Math.max(0,t.top),right:$(window).width()-Math.max(0,t.right),bottom:$(window).height()-Math.max(0,t.bottom),"border-width":0,"border-top-width":0,"background-color":"transparent"},e.css(H),e.addClass("expanded"),e.removeAttr("style"),b()}else e.css(H),setTimeout(()=>{e.removeClass("expanded",S),e.removeAttr("style"),_.defer(b)},300)},T=e=>Math.min(10,Math.max(1,Math.floor(1/(e||f)))),N=e=>{if($(".viewport-content"),m){let t="setProperty"in m.style?"setProperty":"setAttribute";m.style[t]("font-size",48*e+"px","important"),m.style[t]("line-height",64*e+"px","important"),m.style[t]("height","auto","important"),m.style[t]("width",100*e+"%","important")}},V=(e,t,l)=>{if(e>t)return null;let o=Math.floor((e+t)/2),s=h[o],i={left:s.el.offsetLeft,top:s.el.offsetTop};return i.bottom=i.top+s.el.offsetHeight,i.right=i.left+s.el.offsetWidth,l.top>i.bottom?V(o+1,t,l):l.bottom<i.top?V(e,o-1,l):o},w=(e,t)=>{let l=Math.min(10,Math.max(1,e)),o=$("div.viewport-content");if(d!=l){let s=l/d;k===null&&(k={x:o.scrollLeft(),y:o.scrollTop()});let i={x:Math.max(0,k.x+t.x-t.x/s),y:Math.max(0,k.y+t.y-t.y/s)};d=l,C(d,!0,i)}d=l};let E=null;const C=(e,t,l)=>{let o=$("div.viewport-content"),s=e/(W||1);W=e;let i=300,r={x:l.x*s,y:l.y*s};t?(k=r,$(".document-image-layout").css({width:100*e+"%",left:-r.x+o.scrollLeft()+"px",top:-r.y+o.scrollTop()+"px",margin:"0 100% 100% 0",transition:t?"width "+i+"ms, height "+i+"ms, left "+i+"ms, top "+i+"ms":"none"}),E&&clearTimeout(E),E=setTimeout(function(){E=null,k=null,$(".document-image-layout").css({left:0,top:0,margin:0,"margin-bottom":Math.max(0,r.y+o[0].clientHeight-$(".document-image-layout").height())+"px",transition:"none"}),o.scrollLeft(r.x),o.scrollTop(r.y),b()},i)):$(".document-image-layout").css({width:100*e+"%",left:-r.x+o.scrollLeft()+"px",top:-r.y+o.scrollTop()+"px",transition:"none"})},Z=(e,t)=>V(e,e,t)!==null,le=()=>{let t=$("div.viewport-content");q.resetPriority();let l={top:t.scrollTop(),left:t.scrollLeft()};l.right=l.left+t.width(),l.bottom=l.top+t.height(),l.top-=200,l.bottom+=200;let o=V(0,h.length-1,l),s=o,i=o;for(let n=o-1;n>=0&&Z(n,l);n--)s=n;for(let n=o+1;n<I&&Z(n,l);n++)i=n;let r;if(Modernizr.touchevents?r=document.body.clientWidth/window.innerWidth:r=f*d,h.forEach((n,a)=>{a>=s&&a<=i?(n.scale=r,n.visible=!0):n.visible=!1}),s!==null){let n=h[s];l.top+=200,l.bottom-=200;let a={top:n.el.offsetTop};a.bottom=a.top=a.top+n.el.offsetHeight/2,a.top>l.bottom?s=Math.max(0,s-T()):a.bottom<l.top&&(s=Math.min(I-1,s+T())),A(h[s])}},b=_.debounce(le,50),L=e=>{let t=$("div.viewport-content");e.preventDefault();let l={x:e.pageX-t.offset().left,y:e.pageY-t.offset().top},o,s=$(e.target).closest(".document-image"),i;h.forEach((r,n)=>{r.el===s[0]&&(i=r)}),i&&(A(i),Y(i)),e.type=="dblclick"?d>=1/f?(o=1,w(o,l)):(d=1/f,C(1/f,!0,{x:i.$el.position().left,y:i.$el.position().top})):(e.which||(e.which=e.keyCode),e.type==="click"&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey?f==1?(o=1.5*d,w(o,l)):(o=1,B(i,o)):(e.type==="contextmenu"||e.ctrlKey||e.metaKey||e.shiftKey)&&(d>1?f<1?(o=1,w(o,l)):(o=1/1.5*d,w(o,l)):(o=1/(T()+1),B(i,o))))},oe=()=>{let e=$("div.viewport-content"),t=f*d;t<1?(t=1/(T(t)-1),B(_.find(h,function(l){return l===P}),t)):(t=1.5*d,w(t,{x:e.width()/2,y:e.height()/2}))},ie=()=>{let e=$("div.viewport-content"),t=f*d;t<=1?(t=1/Math.min(10,T(t)+1),B(_.find(h,function(l){return l===P}),t)):(t=1/1.5*d,w(t,{x:e.width()/2,y:e.height()/2}))},Q=e=>{e.preventDefault();let t={x:e.offsetX,y:e.offsetY},l=1+Math.min(1,Math.max(-1,e.deltaY))*.1;w(d*l,t)},B=(e,t)=>{let l=$("div.viewport-content"),o=t/f,s=f,i;f=t;const r=n=>n?{x:n.$el[0].offsetLeft,y:n.$el[0].offsetTop}:{x:l.scrollLeft(),y:l.scrollTop()};if(o<1){if(f<1/I||$(".document-image-layout").height()<=l[0].clientHeight){f=s;return}let n,a,p,u,v;if(e){n=Math.max(0,e.$el.position().top-l.scrollTop()),a=T(s),u=T();let R=parseInt(e.$el.data("page"))-1;p=(R+(i||0))%a,v=R%u,p>=(u-1)/2&&(p=u-(u-1-p)),u>2&&I>3&&(i=(p-v+u)%u,z.css({width:100*f*i+"%"}))}else z.css({width:0});N(f);let g;e?(g=r(e),p>=(u-1)/2||u==2&&v==1?g.x=l.width()-l.width()*o:e&&(g.x=0),g.y-=n*o):g={x:0,y:0},C(1/o,!1,g),_.defer(function(){C(1,!0,{x:0,y:g.y/o})})}else if(o>1){let n=r(e);C(o,!0,n),setTimeout(()=>{z.css({width:"0%"}),i=0,l.scrollTop(0),l.scrollLeft(0),C(1,!1,{x:0,y:0}),N(f),e&&(l.scrollTop(e.$el.position().top),l.scrollLeft(e.$el.position().left))},300)}setTimeout(()=>{d=1,b()},300)},se=e=>{e.which!==1||e.which!==3&&U!=="magnify"||(O={x:e.clientX,y:e.clientY},$(document).on("mousemove",G),$(document).one("mouseup",ne),e.preventDefault())},ne=e=>{O=null,$(document).off("mousemove",G)},G=e=>{let t=O,l={x:e.clientX,y:e.clientY},o=$("div.viewport-content");o.scrollLeft(o.scrollLeft()+t.x-l.x),o.scrollTop(o.scrollTop()+t.y-l.y),O=l},re=()=>{let e=document.getElementById("page-selector"),t=e.firstElementChild,l=e.lastElementChild;X=parseInt(t.value),K=parseInt(l.value),$(".first-page").on("click",()=>{D(X)}),$(".last-page").on("click",()=>{D(K)}),$(".next-page").on("click",()=>{D(M+1)}),$(".prev-page").on("click",()=>{D(M-1)}),e.addEventListener("change",()=>{D(parseInt(e.value))});let o=document.querySelector("div.tool-buttons button.magnify"),s=document.querySelector("div.tool-buttons button.scroll"),i=document.querySelector("div.tool-buttons button.expand"),r=document.querySelector("div.zoom-buttons button.zoom-in"),n=document.querySelector("div.zoom-buttons button.zoom-out"),a=$("div.viewport-content");o.addEventListener("click",()=>{F(a,"magnify")}),s.addEventListener("click",()=>{F(a,"scroll")}),i.addEventListener("click",()=>{te(a)}),r.addEventListener("click",()=>{oe()}),n.addEventListener("click",()=>{ie()});let p=a.find(".document-image");p.each((R,j)=>{let x=$(j);h.push(new ee({el:j,$el:x,page:x.data("page"),alt:x.data("alt"),urls:{full:x.data("full-url"),screen:x.data("screen-url"),thumb:x.data("thumb-url")},size:{width:parseInt(x.data("width")),height:parseInt(x.data("height"))}}))}),h.forEach(R=>{R.init()}),a.data("document-id"),I=p.length;let u=a.find(".document-image-layout");Modernizr.touchevents||F(a,"scroll");let v=document.styleSheets[0],g="cssRules"in v?v.cssRules:v.rules;v.insertRule("body.document-viewer #document-viewport .document-image { width: 100% !important; height: auto !important; }",0),m=g[0],m&&m.cssRules&&(m=m.cssRules[0]),z=$("<div></div>").css({display:"inline-block",width:0,height:"1px"}).prependTo(u),a.on("scroll",()=>{console.log("scroll!"),b()}),a.on("resize",()=>{b()}),a.on("mousedown",se),b(),A(h[0])};document.addEventListener("DOMContentLoaded",re);
