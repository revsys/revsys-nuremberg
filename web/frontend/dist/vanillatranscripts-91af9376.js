$(".clear-search").on("click",function(t){t.preventDefault(),$(this).closest("form").find('input[type="search"]').val("")});let i=$(".viewport-content"),l=i.find(".transcript-text"),r=l.data("seq"),v,q;l.data("page-count");let d=l.data("total-pages"),p=l.data("from-seq"),f=l.data("to-seq"),u=$("input[name=q]").val(),C=10;$(".print-document").on("click",function(){$(".print-options, .print-document").toggleClass("hide")});$(".do-print").on("click",function(t){t.preventDefault();var e=parseInt($(".print-options input[name=pages]").val());if(e>20||e<1)return e=Math.min(Math.max(e,1),20),$(".print-options input[name=pages]").val(e);var a=r+e-f;if(a>1)var n=b(Math.ceil(a/10));n?n.then(function(){k(e)}):k(e)});const M=t=>t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),k=t=>{let e=$(".page").addClass("print-hide"),a=[0,0],n=[0,0],h=0;for(let o=r;o<=r+t-1;o++){let g=e.filter('[data-seq="'+o+'"]');g.removeClass("print-hide"),g.length&&(a[0]=a[0]||g.data("page")||"?",a[1]=g.data("page")||"?",n[0]=n[0]||g.data("seq"),n[1]=g.data("seq"),h+=1)}$(".document-info .print-show").text("Printed "+h+" transcript pages labeled "+_.map(a,M).join(" through ")+" (seq. nos. "+n.join("-")+")"),$(".print-options, .print-document").toggleClass("hide"),window.print(),e.removeClass("print-hide")},c=t=>{r=Math.min(Math.max(t,1),d);let e=i.find('.page[data-seq="'+r+'"]');e.length&&(i.scrollTop(e[0].offsetTop-10),history&&history.replaceState&&history.replaceState(void 0,void 0,location.pathname+location.search.replace(/seq=\d+/,"seq="+t)))},P=t=>{var e=$('.page[data-page="'+t+'"]');return e.length?(c(e.data("seq")),!0):!1},E=t=>{var e=$('.page[data-date="'+t+'"]');return e.length?(c(e.data("seq")),!0):!1};var S=r;c(S);setTimeout(function(){c(S)},100);$(".page-buttons .next-page").on("click",function(){c(r+1)});$(".page-buttons .prev-page").on("click",function(){c(r-1)});$(".page-buttons .first-page").on("click",function(){p<=1?c(1):m({seq:1})});$(".page-buttons .last-page").on("click",function(){p>=d?c(1):m({seq:d})});$("form.go-to-page").on("submit",function(t){t.preventDefault();var e=$(this).find("input[name=page]"),a=e.val();if(a<1)return e.val(1);if(a>d)return e.val(d);$('.page[data-page="'+a+'"]'),P(a)||m({page:a})});$("select.select-date").on("change",function(){var t=$(this).val();E(t)||m({date:t})});const w=(t,e)=>{if(t.find("mark").contents().unwrap(),!e)return;e=e.replace(/evidence:|exhibit:/,"").replace(/((?:\-?\w+)\s*\:\s*(?:"[^"]+"|\([^:]+\)|[\w\-\+\.\|]+))/,"");let a=e.match(/"([^"]+)"/g);a=_.map(a,function(o){return o.replace(/^"|"$/g,"").replace(/[^\w]+/g,"[^\\w]+")}),e=e.replace(/"([^"]+)"/g,"");let n=e.replace(/[^\w\-]+/g," ").replace(/^\s+|\s+$/g,"").replace(/(s|ing|ed|ment)\b/g,"").split(/\ +/g);if(n=_.reject(n,function(o){return!o||o.length<3&&!o.match(/[A-Z]{2,3}|\d+/)}),n=n.concat(a),!n.length)return;let h=new RegExp("\\b("+n.join("|")+")(s|ing|ed|ment)?\\b","ig");t.find("p, span, a").contents().filter(function(){return this.nodeType==3}).replaceWith(function(o,g){return this.textContent.replace(h,function(B,y,D){return"<mark>"+y+(D||"")+"</mark>"})})},x=()=>{l.html(w(l,u))};x();$("input[name=q]").on("keyup",_.debounce(function(){u=this.value,x()},500));$(".clear-search").on("click",function(t){t.preventDefault(),$(this).closest("form").find('input[type="search"]').val("").trigger("keyup")});let s=!1;const b=t=>{if(t=t||1,f>=d){i.find(".below .end-indicator").text("End of transcript");return}else i.find(".below .end-indicator").text("Loading...");if(!s)return s=!0,$.get({url:location.pathname,data:{from_seq:f,to_seq:Math.min(d,f+t*C+1),partial:!0}}).then(function(e){f=e.to_seq;var a=$("<div></div>");a.append($(e.html)),w(a,u),l.append(a),s=!1})},T=()=>{if(p<=1){i.find(".above .end-indicator").text("Beginning of transcript");return}else i.find(".above .end-indicator").text("Loading...");s||(s=!0,$.get({url:location.pathname,data:{from_seq:Math.max(1,p-(C+1)),to_seq:p,partial:!0}}).then(function(t){p=t.from_seq;var e=$("<div></div>");e.append($(t.html)),w(e,u),l.prepend(e),i.scrollTop(i.scrollTop()+e.height()+29),s=!1}))},m=t=>{s||(t.partial=!0,t.seq=t.seq||r,s=!0,l.empty(),$.get({url:location.pathname,data:t}).then(function(e){p=e.from_seq,f=e.to_seq,l.append(e.html),x(),e.seq&&c(e.seq),s=!1}))};p<=1&&T();f>=d&&b();i.on("click","a.view-image",t=>{var e=$(globalThis).closest(".page-handle"),a=e.find(".download-image").attr("href");e.hasClass("has-image")||e.addClass("has-image").after('<div class="page-image hide"><img src="'+a+'" /></div>'),$img=e.next(".page-image"),$img.toggleClass("hide"),$img.hasClass("hide")?(e.removeClass("show"),e.find("a.view-image").text("VIEW")):(e.addClass("show"),e.find("a.view-image").text("HIDE")),t.stopPropagation()});i.on("click",".page-handle",()=>{$(globalThis).addClass("show")});const j=()=>{let t={top:i.scrollTop(),height:i.height()*2,bottom:i.scrollTop()+i.height()},e={top:0,bottom:i[0].scrollHeight};t.bottom+t.height>e.bottom?b():t.top-t.height<e.top&&T();let a=i[0].getBoundingClientRect(),n={x:a.left+100,y:a.top+10};do{if(n.y+=100,n.y>a.top+1e3)return;var h=document.elementFromPoint(n.x,n.y),o=$(h).closest(".page")}while(o.length==0);r=o.data("seq"),q=o.data("page"),v=o.data("date"),r&&history&&history.replaceState&&history.replaceState(void 0,void 0,location.pathname+location.search.replace(/seq=\d+/,"seq="+r)),v&&$("select.select-date").val(v),q&&$("form.go-to-page input[name=page]").val(q)};i.on("scroll",_.throttle(j,300));
