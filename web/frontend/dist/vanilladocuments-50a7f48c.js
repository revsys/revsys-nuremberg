var w=function(e,t){var o=this;this.element=t,_.bindAll(this,"xhrProgress"),this.state="queued",this.url=e,this.promise=$.Deferred(),this.promise.request=this,this.promise.cancel=function(){o.state==="active"?o.xhr&&o.xhr.abort():o.state="cancelled"}};w.enableXHR=!0;w.failures=0;w.prototype={doDownload:function(e){var t=this;if(this.state="active",Modernizr.xhrresponsetypeblob&&w.enableXHR&&!e)this.xhr=$.ajax({dataType:"native",url:this.url,xhrFields:{responseType:"blob",onprogress:this.xhrProgress}}),this.startTime=Date.now(),this.promise.notify({loaded:0,total:1}),this.xhr.then(function(l){t.state="complete",t.promise.resolve(l)}),this.xhr.fail(function(l,i){if(i!=="abort"&&!e)return w.failures+=1,w.failures>=5&&(w.enableXHR=!1),t.doDownload(!0);t.state="failed",t.error=l,t.promise.reject(l)});else{this.element.src=this.url;var o=imagesLoaded(this.element,function(){o.images[0].isLoaded?(t.state="complete",t.promise.resolve("fallback")):(t.state="failed",t.promise.reject({fallbackError:"failed"}))})}},xhrProgress:function(e){this.promise.notify(e)}};var O={activeCount:0,active:null,queued:null,requests:{},complete:{},download:function(e,t){var o;if(o=this.requests[e],o){if(o.state==="complete"||o.state==="active")return o.promise;if(o.state==="queued")return this.moveToFront(o),o.promise}return o=new w(e,t),this.requests[e]=o,this.addToFront(o),o.promise},refresh:function(e){var t=e.request;t.state==="queued"&&this.moveToFront(t)},activate:function(e){if(!(this.activeCount>=5)){this.activeCount+=1;var t=this;this.active=this.remove(e),e.doDownload(),e.promise.always(function(){t.activeCount-=1,t.active=null,t.activateNext()}),this.active===this.front&&(this.front=null)}},activateNext:function(){this.queued&&this.activeCount<5&&(this.queued.state==="cancelled"?(this.remove(this.queued),this.activateNext()):this.activate(this.queued))},addToFront:function(e){this.activeCount<5?this.activate(e):this.queued?this.front?(e.next=this.front.next,this.front.next=e,e.prev=this.front,this.front=e,e.next&&(e.next.prev=e)):(e.next=this.queued,this.front=e,this.queued=e,e.next.prev=e):(this.queued=e,this.front=e)},moveToFront:function(e){this.remove(e),this.addToFront(e)},remove:function(e){var t=e.next,o=e.prev;return this.queued===e&&(this.queued=t),this.front===e&&(this.front=t),t&&(t.prev=o),o&&(o.next=t),e.next=null,e.prev=null,e},resetPriority:function(){this.front=null}};const te={scale:1,visible:!1,preload:!1,loader:null,cache:{}};class oe{constructor(t){Object.assign(this,te,t)}init(){let t=$("<img></img>").appendTo(this.$el);this.img=t[0];let o=this.size.height/this.size.width,l=$('<div class="aspect-ratio-spacer"></div>').css({"margin-top":o*100+"%"});this.$el.append(l),this.$el.find("img").css({"border-bottom-width":o*5+"px"}).toggleClass("aspect-ratio-wide",o<11/8.5).attr("alt",this.alt),Modernizr.touchevents||this.preloadImage("thumb")}handleVisible(){_.defer(()=>{if(this.visible){let t=this.scale;this.$el.width()>this.size.width||t>2?this.preloadImage("full"):this.$el.width()<250?this.preloadImage("thumb"):this.preloadImage("screen")}})}downloadProgress(t){this.percentLoaded=t.loaded/(t.total||150*1024)*100}preloadImage(t){if(this.loader)if(this.loader.size==t){O.refresh(this.loader);return}else this.loader.cancel();let o=["thumb","screen","full","screen","thumb"],l;for(let s=o.indexOf(t);s<o.length&&(t=o[s],l=this.urls[t],!l);s++);o=["thumb","screen","full"];let i;for(let s=o.indexOf(t);s<o.length&&(i=i||this.cache[o[s]],!i);s++);if(i){this.url=i,this.preloaded=t;return}this.preloaded=null,this.loader=O.download(l,this.img),this.loader.size=t,this.loader.progress(this.downloadProgress).then(s=>{if(s=="fallback")this.cache[t]=this.img.src,this.url=this.img.src,this.preloaded=t,this.loader=null;else{let n=new FileReader;n.readAsDataURL(s),n.onload=()=>{this.cache[t]=n.result,this.url=n.result,this.preloaded=t,this.loader=null}}}).fail(s=>{console.log("preloadImage failed!"),console.dir(this),this.loader=null})}}let L=1,C=null,Q="scoll",N=null,X=null,p=1,g=1,W=null,R=!1,E=null,f=null,v=[],U=null,y=null,F=null,x=null,z=null;const M=e=>{v[L-1].$el.removeClass("current"),L=Math.min(Math.max(e,N),X);let t=document.getElementById("page-selector");t.value=L;let o=v[L-1];o.$el.addClass("current"),E=null,A(o)},j=e=>{E=e;let t=$(".viewport-content");(!f||f.$el[0].offsetTop+f.$el[0].offsetHeight>t.scrollTop()+t.height()||f.$el[0].offsetTop<t.scrollTop())&&A(E)},A=e=>{let t=$(".viewport-content"),o=f;e||(f=o),f=e,f.current=!0,o&&(o.current=!1),f!==E&&((t.scrollTop()>f.el.offsetTop||t.scrollTop()+t.height()<f.el.offsetTop+f.el.offsetHeight)&&t.scrollTop(f.el.offsetTop),(t.scrollLeft()>f.el.offsetLeft||t.scrollLeft()+t.width()<f.el.offsetLeft+f.el.offsetWidth)&&t.scrollLeft(f.el.offsetLeft))},V=(e,t)=>{Q=t,e.removeClass("tool-magnify tool-scroll"),e.off("mousewheel",Z),e.off("click",T),e.off("contextmenu",T),e.off("dblclick",T),t==="magnify"?(e.addClass("tool-magnify"),e.on("mousewheel",Z),e.on("dblclick",T)):(e.addClass("tool-scroll"),e.on("click",T),e.on("contextmenu",T))};let B;const le=e=>{if(R=!R,R){let t=e[0].getBoundingClientRect();B={position:"fixed",left:Math.max(0,t.left),top:Math.max(0,t.top),right:$(window).width()-Math.max(0,t.right),bottom:$(window).height()-Math.max(0,t.bottom),"border-width":0,"border-top-width":0,"background-color":"transparent"},e.css(B),e.addClass("expanded"),e.removeAttr("style"),b()}else e.css(B),setTimeout(()=>{e.removeClass("expanded",R),e.removeAttr("style"),_.defer(b)},300)},I=e=>Math.min(10,Math.max(1,Math.floor(1/(e||p)))),Y=e=>{if($(".viewport-content"),x){let t="setProperty"in x.style?"setProperty":"setAttribute";x.style[t]("font-size",48*e+"px","important"),x.style[t]("line-height",64*e+"px","important"),x.style[t]("height","auto","important"),x.style[t]("width",100*e+"%","important")}},H=(e,t,o)=>{if(e>t)return null;let l=Math.floor((e+t)/2),i=v[l],s={left:i.el.offsetLeft,top:i.el.offsetTop};return s.bottom=s.top+i.el.offsetHeight,s.right=s.left+i.el.offsetWidth,o.top>s.bottom?H(l+1,t,o):o.bottom<s.top?H(e,l-1,o):l},k=(e,t)=>{let o=Math.min(10,Math.max(1,e)),l=$("div.viewport-content");if(g!=o){let i=o/g;C===null&&(C={x:l.scrollLeft(),y:l.scrollTop()});let s={x:Math.max(0,C.x+t.x-t.x/i),y:Math.max(0,C.y+t.y-t.y/i)};g=o,D(g,!0,s)}g=o};let S=null;const D=(e,t,o)=>{let l=$("div.viewport-content"),i=e/(W||1);W=e;let s=300,n={x:o.x*i,y:o.y*i};t?(C=n,$(".document-image-layout").css({width:100*e+"%",left:-n.x+l.scrollLeft()+"px",top:-n.y+l.scrollTop()+"px",margin:"0 100% 100% 0",transition:t?"width "+s+"ms, height "+s+"ms, left "+s+"ms, top "+s+"ms":"none"}),S&&clearTimeout(S),S=setTimeout(function(){S=null,C=null,$(".document-image-layout").css({left:0,top:0,margin:0,"margin-bottom":Math.max(0,n.y+l[0].clientHeight-$(".document-image-layout").height())+"px",transition:"none"}),l.scrollLeft(n.x),l.scrollTop(n.y),b()},s)):$(".document-image-layout").css({width:100*e+"%",left:-n.x+l.scrollLeft()+"px",top:-n.y+l.scrollTop()+"px",transition:"none"})},G=(e,t)=>H(e,e,t)!==null,ie=()=>{let t=$("div.viewport-content");O.resetPriority();let o={top:t.scrollTop(),left:t.scrollLeft()};o.right=o.left+t.width(),o.bottom=o.top+t.height(),o.top-=200,o.bottom+=200;let l=H(0,v.length-1,o),i=l,s=l;for(let a=l-1;a>=0&&G(a,o);a--)i=a;for(let a=l+1;a<y&&G(a,o);a++)s=a;let n;if(Modernizr.touchevents?n=document.body.clientWidth/window.innerWidth:n=p*g,v.forEach((a,c)=>{c>=i&&c<=s?(a.scale=n,a.visible=!0):a.visible=!1}),i!==null){let a=v[i];o.top+=200,o.bottom-=200;let c={top:a.el.offsetTop};c.bottom=c.top=c.top+a.el.offsetHeight/2,c.top>o.bottom?i=Math.max(0,i-I()):c.bottom<o.top&&(i=Math.min(y-1,i+I())),j(v[i])}},b=_.debounce(ie,50),T=e=>{let t=$("div.viewport-content");e.preventDefault();let o={x:e.pageX-t.offset().left,y:e.pageY-t.offset().top},l,i=$(e.target).closest(".document-image"),s;v.forEach((n,a)=>{n.el===i[0]&&(s=n)}),s&&(j(s),A(s)),e.type=="dblclick"?g>=1/p?(l=1,k(l,o)):(g=1/p,D(1/p,!0,{x:s.$el.position().left,y:s.$el.position().top})):(e.which||(e.which=e.keyCode),e.type==="click"&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey?p==1?(l=1.5*g,k(l,o)):(l=1,J(s,l)):(e.type==="contextmenu"||e.ctrlKey||e.metaKey||e.shiftKey)&&(g>1?p<1?(l=1,k(l,o)):(l=1/1.5*g,k(l,o)):(l=1/(I()+1),J(s,l))))},Z=e=>{e.preventDefault();let t={x:e.offsetX,y:e.offsetY},o=1+Math.min(1,Math.max(-1,e.deltaY))*.1;k(g*o,t)},J=(e,t)=>{let o=$("div.viewport-content"),l=t/p,i=p,s;p=t;const n=a=>a?{x:a.$el[0].offsetLeft,y:a.$el[0].offsetTop}:{x:o.scrollLeft(),y:o.scrollTop()};if(l<1){if(p<1/y||$(".document-image-layout").height()<=o[0].clientHeight){p=i;return}let a,c,m,u,d;if(e){a=Math.max(0,e.$el.position().top-o.scrollTop()),c=I(i),u=I();let h=parseInt(e.$el.data("page"))-1;m=(h+(s||0))%c,d=h%u,m>=(u-1)/2&&(m=u-(u-1-m)),u>2&&y>3&&(s=(m-d+u)%u,F.css({width:100*p*s+"%"}))}else F.css({width:0});Y(p);let r;e?(r=n(e),m>=(u-1)/2||u==2&&d==1?r.x=o.width()-o.width()*l:e&&(r.x=0),r.y-=a*l):r={x:0,y:0},D(1/l,!1,r),_.defer(function(){D(1,!0,{x:0,y:r.y/l})})}else if(l>1){let a=n(e);D(l,!0,a),setTimeout(()=>{F.css({width:"0%"}),s=0,o.scrollTop(0),o.scrollLeft(0),D(1,!1,{x:0,y:0}),Y(p),e&&(o.scrollTop(e.$el.position().top),o.scrollLeft(e.$el.position().left))},300)}setTimeout(()=>{g=1,b()},300)},se=e=>{e.which!==1||e.which!==3&&Q!=="magnify"||(z={x:e.clientX,y:e.clientY},$(document).on("mousemove",ee),$(document).one("mouseup",ne),e.preventDefault())},ne=e=>{z=null,$(document).off("mousemove",ee)},ee=e=>{let t=z,o={x:e.clientX,y:e.clientY},l=$("div.viewport-content");l.scrollLeft(l.scrollLeft()+t.x-o.x),l.scrollTop(l.scrollTop()+t.y-o.y),z=o},ae=(e,t,o)=>{var l=o-t+1,i=0;$(".pdf-loading").removeClass("hide"),$(".download-options").addClass("hide"),$(".pdf-loading .progress").text(i+"/"+l+" loaded"),$(".pdf-loading .progress").text("Building PDF."),setTimeout(function(){re(e,t,o)},100)},re=(e,t,o)=>{var l=new jsPDF("p","in"),i=75;{var s={300:"light",400:"normal",500:"medium",600:"bold"},n=1*i;l.text(.5,n/i,"Harvard Law School Library - Nuremberg Trials Project"),n+=1/4*i,$(".document-info").children("h3,h5,h6,p,br").each(function(u,d){if(d.tagName==="BR"){n+=15;return}d.tagName==="H3"&&(n+=20);var r=$(d);n+=parseFloat(r.css("margin-top"));var h=r.css("font-family").split(", "),P=r.css("font-weight");P=s[P]||P;var K=parseFloat(r.css("font-size"))-3,q=l.setFontType(P).setFontSize(K).setFont(h[h.length-1]).splitTextToSize(d.innerText,7);l.text(.5,n/i,q),n+=(q.length+1/2)*K}),n+=15,l.text(.5,n/i,"Pages "+t+" to "+o+" included")}console.log("== IMAGES =="),console.dir(e);for(var a=t-1;a<=o-1;a++){var c=e[a];let u=c.cache.thumb;l.addPage(c.size.width/i,c.size.height/i),l.addImage(u,"JPEG",0,0,c.size.width/i,c.size.height/i)}if(o===t)var m=" page "+o;else m=" pages "+t+"-"+o;l.save("HLSL Nuremberg Document #"+U+m+".pdf"),$(".download-pdf").removeClass("hide"),$(".pdf-loading").addClass("hide")},ce=()=>{let e=document.getElementById("page-selector"),t=e.firstElementChild,o=e.lastElementChild;N=parseInt(t.value),X=parseInt(o.value),$(".first-page").on("click",()=>{M(N)}),$(".last-page").on("click",()=>{M(X)}),$(".next-page").on("click",()=>{M(L+1)}),$(".prev-page").on("click",()=>{M(L-1)}),e.addEventListener("change",()=>{M(parseInt(e.value))});let l=document.querySelector("div.tool-buttons button.magnify"),i=document.querySelector("div.tool-buttons button.scroll"),s=document.querySelector("div.tool-buttons button.expand"),n=$("div.viewport-content");l.addEventListener("click",()=>{V(n,"magnify")}),i.addEventListener("click",()=>{V(n,"scroll")}),s.addEventListener("click",()=>{le(n)});let a=n.find(".document-image");a.each((d,r)=>{let h=$(r);v.push(new oe({el:r,$el:h,page:h.data("page"),alt:h.data("alt"),crossorigin:"anonymous",urls:{full:h.data("full-url"),screen:h.data("screen-url"),thumb:h.data("thumb-url")},size:{width:parseInt(h.data("width")),height:parseInt(h.data("height"))}}))}),v.forEach(d=>{d.init()}),U=n.data("document-id"),y=a.length;let c=n.find(".document-image-layout");Modernizr.touchevents||V(n,"scroll");let m=document.styleSheets[0],u="cssRules"in m?m.cssRules:m.rules;m.insertRule("body.document-viewer #document-viewport .document-image { width: 100% !important; height: auto !important; }",0),x=u[0],x&&x.cssRules&&(x=x.cssRules[0]),F=$("<div></div>").css({display:"inline-block",width:0,height:"1px"}).prependTo(c),n.on("scroll",()=>{b()}),n.on("resize",()=>{b()}),n.on("mousedown",se),b(),j(v[0]),$(".download-pdf").on("click",function(){$(".download-pdf").addClass("hide"),$(".download-options").removeClass("hide"),$(".download-options input[name=from-page]").val(1),$(".download-options input[name=to-page]").val(y)}),$(".do-download").on("click",function(){var d=parseInt($(".download-options input[name=from-page]").val()),r=parseInt($(".download-options input[name=to-page]").val());if(r<d){var h=r;r=d,d=h}if(d>y||r>y||d<1||r<1){$(".download-options input[name=from-page]").val(1),$(".download-options input[name=to-page]").val(y);return}ae(v,d,r)})};document.addEventListener("DOMContentLoaded",ce);
